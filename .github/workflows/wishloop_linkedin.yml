name: Scan LinkedIn Emails (WishLoop)

on:
  # Runs every day at 07:00 UTC (change as you like)
  schedule:
    - cron: '0 7 * * *'
  # Allow manual runs with parameters
  workflow_dispatch:
    inputs:
      daysBack:
        description: 'How many days back to scan'
        required: false
        default: '360'
      maxEmails:
        description: 'Maximum number of emails to fetch'
        required: false
        default: '300'
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'false'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Call WishLoop function (scanLinkedInEmails)
        env:
          # GitHub → Repo → Settings → Secrets and variables → Actions
          APP_ID:  ${{ secrets.BASE44_APP_ID }}            # e.g. 6902d23cfff0eb754ab4d767
          API_KEY: ${{ secrets.BASE44_API_KEY }}           # your Base44/WishLoop API key
          BASE_URL: ${{ secrets.WISHLOOP_URL }}           # e.g. https://wish-loop-4ab4d767.base44.app (no trailing slash)
        run: |
          set -euo pipefail

          # Read inputs with safe defaults
          DAYS_BACK='${{ github.event.inputs.daysBack || '360' }}'
          MAX_EMAILS='${{ github.event.inputs.maxEmails || '300' }}'
          DRY_RUN='${{ github.event.inputs.dry_run   || 'false' }}'

          # Ensure BASE_URL has no trailing slash, then build the endpoint
          TRIMMED_BASE_URL="${BASE_URL%/}"
          URL="${TRIMMED_BASE_URL}/api/apps/${APP_ID}/functions/scanLinkedInEmails"

          echo "POST ${URL}"
          echo "Payload: daysBack=${DAYS_BACK}, maxEmails=${MAX_EMAILS}, dry_run=${DRY_RUN}"

          # Call your WishLoop server function
          curl -sS -X POST "${URL}" \
            -H "Content-Type: application/json" \
            -H "api_key: ${API_KEY}" \
            -d "{\"daysBack\": ${DAYS_BACK}, \"maxEmails\": ${MAX_EMAILS}, \"dry_run\": ${DRY_RUN}}"
